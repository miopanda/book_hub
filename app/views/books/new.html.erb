<div class="contents row">
  <div class="container">

    <h3>本を登録する</h3>

    <%= form_with model: @book, local: true do |f| %>
      <%= f.text_field :title, placeholder: "本のタイトル" %>
      <%= f.text_field :publisher, placeholder: "出版社" %>
      <%= f.text_field :image_url, placeholder: "Image url" %>
      <%= f.submit "登録する" %>
    <% end %>

  </div>
</div>



<h3>登録する本の情報を検索する</h3>

<div class="search">
    <input id="key" type="text" placeholder="Google ブックスから検索">
    <button id="search">検索</button>
</div>

<div>
  <table id="books">
    <tr>
      <td style="width:400px">本のタイトル</td>
      <td style="width:200px">出版社</td>
      <td style="width:300px">画像</td>
    </tr>
  </table>
</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script>
// 検索ボタンをクリックしたら、
  $("#search").on("click", function(){
    const url = "https://www.googleapis.com/books/v1/volumes?q="+$("#key").val();
    $.ajax({
      url: url,
      dataType: "json"
    }).done(function(data) {
      //書籍名、出版社、サムネイル[リンク]
      console.log(data);
      const len = data.items.length; //データの数を取得
      let html;
      for(let i=0; i<len; i++){
          if(typeof data.items[i].volumeInfo.publisher=="undefined"){
            data.items[i].volumeInfo.publisher="出版社(不明)";
          }
          html += `
              <tr>
                <td>${data.items[i].volumeInfo.title}</td>
                <td>${data.items[i].volumeInfo.publisher}</td>
                <td>
                  <a target="_blank" href="${data.items[i].volumeInfo.infoLink}">
                  <img src="${data.items[i].volumeInfo.imageLinks.smallThumbnail}">
                  </a>
                </td>
                <td><button id="regBook${i}">選択</button></td>
              </tr>
          `;
      }
      //table要素のid="books"に追加
      $("#books").empty().hide().append(html).fadeIn(1000);

      for(let i=0; i<len; i++){
        $("#regBook" + i).on("click", function(){
          const bookData = {
            title: data.items[i].volumeInfo.title,
            publisher: data.items[i].volumeInfo.publisher,
            image: data.items[i].volumeInfo.imageLinks.smallThumbnail,
          };

          // フォームの各フィールドにbookDataの値を設定
          $("#book_title").val(bookData.title);
          $("#book_publisher").val(bookData.publisher);
          $("#book_image_url").val(bookData.image);

          // フォームを送信
          $("#book_form").submit();
        });
        
      }
      
    });
  });
  
  
</script>